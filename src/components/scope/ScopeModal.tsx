'use client'

import {useState, useEffect} from 'react'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter
} from '@/components/ui/dialog'
import {Button} from '@/components/ui/button'
import {Alert, AlertDescription} from '@/components/ui/alert'
import {AlertCircle, Calculator, Cloud} from 'lucide-react'

// Î∂ÑÎ¶¨Îêú Ïª¥Ìè¨ÎÑåÌä∏Îì§ import
import BasicInfoForm from './BasicInfoForm'
import ActivityTypeSelector from './ActivityTypeSelector'
import StationaryCombustionForm from './StationaryCombustionForm'
import MobileCombustionForm from './MobileCombustionForm'
import ElectricityForm from './ElectricityForm'
import SteamForm from './SteamForm'
import CalculationResult from './CalculationResult'

import type {
  PartnerCompany,
  ScopeFormData,
  EmissionActivityType,
  StationaryCombustionType,
  MobileCombustionType,
  SteamType,
  FuelType,
  EmissionCalculationResult,
  PurposeCategory
} from '@/types/scopeType'

import {
  fetchFuelsByActivityType,
  calculateEmissions,
  submitScopeData,
  validateScopeFormData
} from '@/services/scopeService'

// fuel-data.tsÏóêÏÑú Ïó∞Î£å Îç∞Ïù¥ÌÑ∞ÏôÄ Ìó¨Ìçº Ìï®ÏàòÎì§ import
import {
  FUEL_DATA,
  getAllFuels,
  getFuelById,
  getFuelsByActivityType as getFuelsByActivityTypeLocal,
  getEmissionFactorByPurpose,
  GWP
} from '@/constants/fuel-data'

import {useToast} from '@/util/toast'

interface ScopeModalProps {
  isOpen: boolean
  onClose: () => void
  onSubmit: (data: ScopeFormData) => void
  partnerCompanies: PartnerCompany[]
  defaultPartnerId?: string
  defaultYear?: number
  defaultMonth?: number
  scope: 'SCOPE1' | 'SCOPE2'
}

/**
 * Scope Î∞∞Ï∂úÎüâ Îç∞Ïù¥ÌÑ∞ ÏûÖÎ†• Î™®Îã¨ Ïª¥Ìè¨ÎÑåÌä∏
 *
 * Ï£ºÏöî Í∏∞Îä•:
 * - ÌòëÎ†•ÏÇ¨Î≥Ñ Î∞∞Ï∂úÎüâ Îç∞Ïù¥ÌÑ∞ ÏûÖÎ†•
 * - Scope 1 (ÏßÅÏ†ë Î∞∞Ï∂ú): Í≥†Ï†ïÏó∞ÏÜå, Ïù¥ÎèôÏó∞ÏÜå
 * - Scope 2 (Í∞ÑÏ†ë Î∞∞Ï∂ú): Ï†ÑÎ†•ÏÇ¨Ïö©, Ïä§ÌåÄÏÇ¨Ïö©
 * - Ïã§ÏãúÍ∞Ñ Î∞∞Ï∂úÎüâ Í≥ÑÏÇ∞
 * - Îç∞Ïù¥ÌÑ∞ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
 * - ÏÑúÎ≤Ñ Ï†ÄÏû• Í∏∞Îä•
 */
export default function ScopeModal({
  isOpen,
  onClose,
  onSubmit,
  partnerCompanies,
  defaultPartnerId,
  defaultYear = new Date().getFullYear(),
  defaultMonth = new Date().getMonth() + 1,
  scope
}: ScopeModalProps) {
  const toast = useToast()

  // ÏÑ†ÌÉùÎêú ÌòëÎ†•ÏÇ¨ Ï†ïÎ≥¥ Ï∞æÍ∏∞
  const selectedPartner = partnerCompanies.find(p => p.id === defaultPartnerId)

  // ÏÉÅÌÉú Í¥ÄÎ¶¨
  const [formData, setFormData] = useState<ScopeFormData>({
    companyId: defaultPartnerId || '',
    reportingYear: defaultYear,
    reportingMonth: defaultMonth,
    emissionActivityType: scope === 'SCOPE1' ? 'STATIONARY_COMBUSTION' : 'ELECTRICITY'
  })

  const [availableFuels, setAvailableFuels] = useState<FuelType[]>([])
  const [calculationResult, setCalculationResult] =
    useState<EmissionCalculationResult | null>(null)
  const [errors, setErrors] = useState<string[]>([])
  const [isLoading, setIsLoading] = useState(false)
  const [isCalculating, setIsCalculating] = useState(false)

  /**
   * Ïó∞Î£å Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞ Ìï®Ïàò
   * ÏÑ†ÌÉùÎêú Î∞∞Ï∂ú ÌôúÎèô Ïú†ÌòïÏóê Îî∞Îùº Ï†ÅÏ†àÌïú Ïó∞Î£å Î™©Î°ùÏùÑ Í∞ÄÏ†∏Ïò¥
   */
  const loadFuels = async () => {
    if (!formData.emissionActivityType) return

    try {
      let subType: string | undefined

      // Í≥†Ï†ïÏó∞ÏÜåÏùò Í≤ΩÏö∞ Ïó∞Î£å Ïú†ÌòïÏóê Îî∞Îùº ÏÑúÎ∏åÌÉÄÏûÖ ÏÑ§Ï†ï
      if (
        formData.emissionActivityType === 'STATIONARY_COMBUSTION' &&
        formData.stationaryCombustion
      ) {
        subType = formData.stationaryCombustion.combustionType
      }
      // Ïù¥ÎèôÏó∞ÏÜåÏùò Í≤ΩÏö∞ Ï†ÑÏ≤¥ Ïù¥ÎèôÏó∞ÏÜå Ïó∞Î£åÎ•º Í∞ÄÏ†∏Ïò¥
      else if (formData.emissionActivityType === 'MOBILE_COMBUSTION') {
        subType = undefined
      }

      // fuel-data.tsÏùò getFuelsByActivityType Ìï®Ïàò ÏÇ¨Ïö©
      const fuels = getFuelsByActivityTypeLocal(formData.emissionActivityType, subType)

      console.log('üîç Í∏∞Î≥∏ Ïó∞Î£å Î™©Î°ù (ÌïÑÌÑ∞ÎßÅ Ï†Ñ):', {
        activityType: formData.emissionActivityType,
        subType,
        totalFuels: fuels.length,
        fuels: fuels.map(f => ({
          id: f.id,
          name: f.name,
          subcategoryType: f.subcategoryType,
          hasMobileFactors: !!f.mobileEmissionFactors
        }))
      })

      // Ïù¥ÎèôÏó∞ÏÜåÏùò Í≤ΩÏö∞ mobileEmissionFactorsÍ∞Ä ÏûàÎäî Ïó∞Î£åÎßå ÌïÑÌÑ∞ÎßÅ
      let filteredFuels = fuels
      if (formData.emissionActivityType === 'MOBILE_COMBUSTION') {
        filteredFuels = fuels.filter(fuel => fuel.mobileEmissionFactors)
        console.log('üöó Ïù¥ÎèôÏó∞ÏÜå Ïó∞Î£å ÌïÑÌÑ∞ÎßÅ Í≤∞Í≥º:', {
          beforeFilter: fuels.length,
          afterFilter: filteredFuels.length,
          mobileFuels: filteredFuels.map(f => ({
            id: f.id,
            name: f.name,
            unit: f.unit,
            mobileFactors: f.mobileEmissionFactors
          }))
        })
      }

      setAvailableFuels(filteredFuels)
      console.log(
        '‚úÖ ÏµúÏ¢Ö Î°úÎìúÎêú Ïó∞Î£å Î™©Î°ù:',
        filteredFuels.map(f => ({
          id: f.id,
          name: f.name,
          unit: f.unit,
          subcategoryType: f.subcategoryType,
          hasMobileFactors: !!f.mobileEmissionFactors
        }))
      )
    } catch (error) {
      console.error('Ïó∞Î£å Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:', error)
      toast.error('Ïó∞Î£å Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.')
    }
  }

  // Ïó∞Î£å Î™©Î°ù Î°úÎìú effect
  useEffect(() => {
    loadFuels()
  }, [
    formData.emissionActivityType,
    formData.stationaryCombustion?.combustionType,
    formData.mobileCombustion?.transportType
  ])

  /**
   * Î∞∞Ï∂úÎüâ Í≥ÑÏÇ∞ Ìï®Ïàò
   */
  const handleCalculateEmissions = async () => {
    if (isCalculating) return

    let fuelId: string | undefined
    let usage: number | undefined
    let purposeCategory: PurposeCategory | undefined

    const toNumber = (value: string | number): number => {
      return typeof value === 'string' ? parseFloat(value) : value
    }

    const validateUsage = (value: number): boolean => {
      return value > 0 && value <= 1000000
    }

    // Î∞∞Ï∂ú ÌôúÎèô Ïú†ÌòïÎ≥Ñ Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú
    if (
      formData.emissionActivityType === 'STATIONARY_COMBUSTION' &&
      formData.stationaryCombustion
    ) {
      fuelId = formData.stationaryCombustion.fuelId
      usage = toNumber(formData.stationaryCombustion.fuelUsage)
      purposeCategory = formData.stationaryCombustion.purposeCategory
    } else if (
      formData.emissionActivityType === 'MOBILE_COMBUSTION' &&
      formData.mobileCombustion
    ) {
      fuelId = formData.mobileCombustion.fuelId
      usage = toNumber(formData.mobileCombustion.fuelUsage)
      purposeCategory = formData.mobileCombustion.purposeCategory
    } else if (formData.emissionActivityType === 'ELECTRICITY' && formData.electricity) {
      fuelId = 'ELECTRICITY'
      usage = toNumber(formData.electricity.electricityUsage)
    } else if (formData.emissionActivityType === 'STEAM' && formData.steam) {
      fuelId = `STEAM_${formData.steam.steamType.replace('TYPE_', '')}`
      usage = toNumber(formData.steam.steamUsage)
    }

    // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
    if (!fuelId) {
      toast.warning('Ïó∞Î£åÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.')
      setErrors(['Ïó∞Î£åÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.'])
      return
    }

    if (!usage || isNaN(usage) || !validateUsage(usage)) {
      toast.warning('ÏÇ¨Ïö©ÎüâÏùÑ 0Î≥¥Îã§ ÌÅ¨Í≥† 1,000,000 Ïù¥ÌïòÏùò Ïú†Ìö®Ìïú Ïà´ÏûêÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.')
      setErrors(['ÏÇ¨Ïö©ÎüâÏùÑ 0Î≥¥Îã§ ÌÅ¨Í≥† 1,000,000 Ïù¥ÌïòÏùò Ïú†Ìö®Ìïú Ïà´ÏûêÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.'])
      return
    }

    if (
      (formData.emissionActivityType === 'STATIONARY_COMBUSTION' ||
        formData.emissionActivityType === 'MOBILE_COMBUSTION') &&
      !purposeCategory
    ) {
      toast.warning('Ïö©ÎèÑ Íµ¨Î∂ÑÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.')
      setErrors(['Ïö©ÎèÑ Íµ¨Î∂ÑÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.'])
      return
    }

    setIsCalculating(true)
    try {
      const result = await calculateEmissions(fuelId, usage, purposeCategory)
      setCalculationResult(result)
      setErrors([])
      toast.success('Î∞∞Ï∂úÎüâÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Í≥ÑÏÇ∞ÎêòÏóàÏäµÎãàÎã§.')
    } catch (error) {
      const errorMessage =
        error instanceof Error ? error.message : 'Í≥ÑÏÇ∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.'
      setErrors([errorMessage])
      setCalculationResult(null)
      toast.error(errorMessage)
    } finally {
      setIsCalculating(false)
    }
  }

  /**
   * Ìèº Ï†úÏ∂ú Ìï®Ïàò
   */
  const handleSubmit = async () => {
    if (isLoading) return

    if (!defaultPartnerId || !selectedPartner) {
      setErrors(['ÌòëÎ†•ÏÇ¨Î•º Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.'])
      toast.error('ÌòëÎ†•ÏÇ¨Î•º Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.')
      return
    }

    const validationErrors = validateScopeFormData(formData)
    if (validationErrors.length > 0) {
      setErrors(validationErrors)
      toast.warning('ÏûÖÎ†•Í∞íÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.')
      return
    }

    setIsLoading(true)
    try {
      const submitData = {
        ...formData,
        companyId: defaultPartnerId
      }

      console.log('üíæ DB Ï†ÄÏû• Îç∞Ïù¥ÌÑ∞:', submitData)

      await submitScopeData(submitData)
      onSubmit(submitData)
      onClose()
      toast.success(
        `${
          selectedPartner.companyName || selectedPartner.corpName || selectedPartner.name
        }Ïùò ${scope} Î∞∞Ï∂úÎüâ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.`
      )
    } catch (error) {
      const errorMessage =
        error instanceof Error ? error.message : 'Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.'
      setErrors([errorMessage])
      toast.error(`Ï†ÄÏû• Ïã§Ìå®: ${errorMessage}`)
    } finally {
      setIsLoading(false)
    }
  }

  /**
   * Î∞∞Ï∂úÌôúÎèô ÌÉÄÏûÖ Î≥ÄÍ≤Ω Ìï∏Îì§Îü¨
   */
  const handleActivityTypeChange = (activityType: EmissionActivityType) => {
    const baseFormData: ScopeFormData = {
      ...formData,
      emissionActivityType: activityType,
      stationaryCombustion: undefined,
      mobileCombustion: undefined,
      electricity: undefined,
      steam: undefined
    }

    // ÌôúÎèô ÌÉÄÏûÖÏóê Îî∞Îùº Í∏∞Î≥∏ Íµ¨Ï°∞ Ï¥àÍ∏∞Ìôî
    if (activityType === 'STATIONARY_COMBUSTION') {
      baseFormData.stationaryCombustion = {
        companyId: defaultPartnerId || '',
        reportingYear: formData.reportingYear,
        reportingMonth: formData.reportingMonth,
        facilityName: '',
        facilityLocation: '',
        combustionType: 'LIQUID' as StationaryCombustionType,
        purposeCategory: 'COMMERCIAL' as PurposeCategory,
        fuelId: '',
        fuelUsage: '',
        unit: '',
        createdBy: 'current-user'
      }
    } else if (activityType === 'MOBILE_COMBUSTION') {
      baseFormData.mobileCombustion = {
        companyId: defaultPartnerId || '',
        reportingYear: formData.reportingYear,
        reportingMonth: formData.reportingMonth,
        vehicleType: '',
        transportType: 'ROAD' as MobileCombustionType,
        purposeCategory: 'COMMERCIAL' as PurposeCategory,
        fuelId: '',
        fuelUsage: '',
        unit: '',
        distance: '',
        createdBy: 'current-user'
      }
    } else if (activityType === 'ELECTRICITY') {
      baseFormData.electricity = {
        companyId: defaultPartnerId || '',
        reportingYear: formData.reportingYear,
        reportingMonth: formData.reportingMonth,
        facilityName: '',
        facilityLocation: '',
        electricityUsage: '',
        unit: 'kWh',
        isRenewable: false,
        renewableType: '',
        createdBy: 'current-user'
      }
    } else if (activityType === 'STEAM') {
      baseFormData.steam = {
        companyId: defaultPartnerId || '',
        reportingYear: formData.reportingYear,
        reportingMonth: formData.reportingMonth,
        facilityName: '',
        facilityLocation: '',
        steamType: 'TYPE_A' as SteamType,
        steamUsage: '',
        unit: 'GJ',
        createdBy: 'current-user'
      }
    }

    setFormData(baseFormData)
    setCalculationResult(null)
    setErrors([])
  }

  // Ìèº Ï¥àÍ∏∞Ìôî effect
  useEffect(() => {
    if (isOpen) {
      if (defaultPartnerId && selectedPartner) {
        setFormData({
          companyId: defaultPartnerId,
          reportingYear: defaultYear,
          reportingMonth: defaultMonth,
          emissionActivityType:
            scope === 'SCOPE1' ? 'STATIONARY_COMBUSTION' : 'ELECTRICITY'
        })
      } else {
        setFormData({
          companyId: '',
          reportingYear: defaultYear,
          reportingMonth: defaultMonth,
          emissionActivityType:
            scope === 'SCOPE1' ? 'STATIONARY_COMBUSTION' : 'ELECTRICITY'
        })
      }

      setCalculationResult(null)
      setErrors([])
    }
  }, [isOpen, defaultPartnerId, selectedPartner, defaultYear, defaultMonth, scope])

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-5xl max-h-[90vh] overflow-y-auto bg-white border-gray-200 custom-scrollbar">
        <DialogHeader className="pb-4 border-b border-gray-100">
          <DialogTitle className="flex items-center gap-3 text-2xl font-bold text-gray-800">
            <div className="p-3 bg-gray-100 rounded-xl">
              <Cloud className="w-6 h-6 text-gray-600" />
            </div>
            <div>
              <h1>{scope} Î∞∞Ï∂úÎüâ Îç∞Ïù¥ÌÑ∞ ÏûÖÎ†•</h1>
              <p className="mt-1 text-sm font-normal text-gray-600">
                ÌòëÎ†•ÏÇ¨Ïùò Î∞∞Ï∂úÎüâ Îç∞Ïù¥ÌÑ∞Î•º ÏûÖÎ†•ÌïòÍ≥† Í≥ÑÏÇ∞ÌïòÏÑ∏Ïöî
              </p>
            </div>
          </DialogTitle>
        </DialogHeader>

        <div className="py-2 space-y-4">
          {/* Ïò§Î•ò Î©îÏãúÏßÄ */}
          {errors.length > 0 && (
            <Alert className="border-red-200 shadow-sm bg-red-50">
              <AlertCircle className="w-4 h-4 text-red-600" />
              <AlertDescription className="text-red-800">
                {errors.map((error, index) => (
                  <div key={index}>{error}</div>
                ))}
              </AlertDescription>
            </Alert>
          )}

          {/* Í∏∞Î≥∏ Ï†ïÎ≥¥ */}
          <BasicInfoForm selectedPartner={selectedPartner} />

          {/* ÌòëÎ†•ÏÇ¨Í∞Ä ÏÑ†ÌÉùÎêú Í≤ΩÏö∞ÏóêÎßå ÎÇòÎ®∏ÏßÄ Ìèº ÌëúÏãú */}
          {selectedPartner && (
            <>
              {/* Î∞∞Ï∂ú ÌôúÎèô Ïú†Ìòï ÏÑ†ÌÉù */}
              <ActivityTypeSelector
                selectedActivityType={formData.emissionActivityType}
                onActivityTypeChange={handleActivityTypeChange}
                scope={scope}
              />

              {/* Í∞Å ÌôúÎèô Ïú†ÌòïÎ≥Ñ Ìèº */}
              {formData.emissionActivityType === 'STATIONARY_COMBUSTION' && (
                <StationaryCombustionForm
                  formData={formData}
                  setFormData={setFormData}
                  availableFuels={availableFuels}
                />
              )}

              {formData.emissionActivityType === 'MOBILE_COMBUSTION' && (
                <MobileCombustionForm
                  formData={formData}
                  setFormData={setFormData}
                  availableFuels={availableFuels}
                />
              )}

              {formData.emissionActivityType === 'ELECTRICITY' && (
                <ElectricityForm formData={formData} setFormData={setFormData} />
              )}

              {formData.emissionActivityType === 'STEAM' && (
                <SteamForm formData={formData} setFormData={setFormData} />
              )}

              {/* Í≥ÑÏÇ∞ Í≤∞Í≥º */}
              {calculationResult && (
                <CalculationResult calculationResult={calculationResult} />
              )}
            </>
          )}
        </div>

        <DialogFooter className="flex flex-col gap-3 pt-6 border-t border-gray-100 sm:flex-row">
          <div className="flex flex-1 gap-3">
            <Button
              type="button"
              variant="outline"
              onClick={handleCalculateEmissions}
              disabled={isCalculating || !selectedPartner}
              className="flex items-center gap-2 text-gray-700 border-gray-300 hover:bg-gray-50 hover:border-gray-400 disabled:opacity-50">
              <Calculator className="w-4 h-4" />
              {isCalculating ? 'Í≥ÑÏÇ∞ Ï§ë...' : 'Î∞∞Ï∂úÎüâ Í≥ÑÏÇ∞'}
            </Button>
          </div>
          <div className="flex gap-3">
            <Button
              type="button"
              variant="outline"
              onClick={onClose}
              disabled={isLoading}
              className="text-gray-700 border-gray-300 hover:bg-gray-50 hover:border-gray-400">
              Ï∑®ÏÜå
            </Button>
            <Button
              type="button"
              onClick={handleSubmit}
              disabled={isLoading || !selectedPartner || !calculationResult}
              className="bg-blue-600 hover:bg-blue-700 disabled:opacity-50">
              {isLoading ? 'Ï†ÄÏû• Ï§ë...' : 'Ï†ÄÏû•'}
            </Button>
          </div>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}
